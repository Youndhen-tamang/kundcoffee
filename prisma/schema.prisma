datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Space {
  id          String   @id @default(uuid())
  name        String
  description String?
  sortOrder   Int      @default(0)
  
  storeId     String
  store       Store    @relation(fields: [storeId], references: [id])
  
  tables      Table[]
  createdAt   DateTime @default(now())
  
  @@index([storeId])
}

model TableSession {
  id      String @id @default(uuid())
  tableId String
  table   Table  @relation(fields: [tableId], references: [id], onDelete: Cascade)

  startedAt DateTime  @default(now())
  endedAt   DateTime?

  total         Float @default(0)
  discount      Float @default(0)
  serviceCharge Float @default(0)
  tax           Float @default(0)
  grandTotal    Float @default(0)

  isActive Boolean  @default(true)
  payment  Payment?
  orders   Order[]

  @@index([tableId])
}

model TableType {
  id      String  @id @default(uuid())
  name    String
  
  storeId String
  store   Store   @relation(fields: [storeId], references: [id])
  
  tables  Table[]
  
  @@unique([name, storeId])
  @@index([storeId])
}

model Table {
  id           String         @id @default(uuid())
  name         String
  tableTypeId  String?
  tableType    TableType?     @relation(fields: [tableTypeId], references: [id])
  capacity     Int
  status       TableStatus    @default(ACTIVE)
  sortOrder    Int            @default(0)
  spaceId      String?
  space        Space?         @relation(fields: [spaceId], references: [id])
  
  storeId      String
  store        Store          @relation(fields: [storeId], references: [id])
  
  qrCode       QRCode?
  sessions     TableSession[]
  reservations Reservation[]
  createdAt    DateTime       @default(now())
  isDeleted    Boolean        @default(false)
  Order        Order[]

  @@index([spaceId])
  @@index([tableTypeId])
  @@index([storeId])
}

model QRCode {
  id        String   @id @default(uuid())
  tableId   String   @unique
  table     Table    @relation(fields: [tableId], references: [id], onDelete: Cascade)
  value     String
  assigned  Boolean  @default(false)
  createdAt DateTime @default(now())
}

enum TableStatus {
  ACTIVE
  OCCUPIED
  INACTIVE
}

model Category {
  id          String  @id @default(uuid())
  name        String
  image       String?
  description String?
  sortOrder   Int     @default(0)
  
  storeId     String
  store       Store   @relation(fields: [storeId], references: [id])

  dishes   Dish[]
  combos   ComboOffer[]
  subMenus SubMenu[]
  addOns   AddOn[]

  createdAt DateTime @default(now())
  
  @@unique([name, storeId])
  @@index([storeId])
}

model SubMenu {
  id        String  @id @default(uuid())
  name      String
  image     String?
  isActive  Boolean @default(true)
  sortOrder Int     @default(0)

  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id])
  
  storeId    String
  store      Store     @relation(fields: [storeId], references: [id])

  dishes  Dish[]
  combos  ComboOffer[]
  menuSet MenuSetSubMenu[]

  createdAt DateTime @default(now())

  @@unique([name, storeId])
  @@index([categoryId])
  @@index([storeId])
}

model Price {
  id            String @id @default(uuid())
  actualPrice   Float
  discountPrice Float? @default(0)
  listedPrice   Float
  cogs          Float
  grossProfit   Float

  dishId  String? @unique
  addOnId String? @unique
  comboId String? @unique

  dish  Dish?       @relation(fields: [dishId], references: [id])
  addOn AddOn?      @relation(fields: [addOnId], references: [id])
  combo ComboOffer? @relation(fields: [comboId], references: [id])

  @@index([dishId])
  @@index([addOnId])
  @@index([comboId])
}

model Stock {
  id           String             @id @default(uuid())
  name         String
  unit         MeasuringUnit?
  quantity     Float
  amount       Float
  
  storeId      String
  store        Store              @relation(fields: [storeId], references: [id])
  
  consumptions StockConsumption[]
  
  @@unique([name, storeId])
  @@index([storeId])
}

model StockConsumption {
  id      String @id @default(uuid())
  stockId String
  stock   Stock  @relation(fields: [stockId], references: [id])

  quantity Float

  dishId  String?
  addOnId String?
  comboId String?

  dish  Dish?       @relation(fields: [dishId], references: [id])
  addOn AddOn?      @relation(fields: [addOnId], references: [id])
  combo ComboOffer? @relation(fields: [comboId], references: [id])

  @@index([stockId])
  @@index([dishId])
  @@index([addOnId])
  @@index([comboId])
}

model Dish {
  id              String   @id @default(uuid())
  name            String
  hscode          String?
  image           String[]
  preparationTime Int
  description     String?
  sortOrder       Int      @default(0)

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  subMenuId String?
  subMenu   SubMenu? @relation(fields: [subMenuId], references: [id])
  
  storeId   String
  store     Store    @relation(fields: [storeId], references: [id])

  type        DishType
  kotType     KOTType
  isAvailable Boolean            @default(true)
  orderItems  OrderItem[]
  price       Price?
  stocks      StockConsumption[]
  addOns      DishAddOn[]
  comboItems  ComboItem[]
  createdAt   DateTime           @default(now())

  @@index([categoryId])
  @@index([subMenuId])
  @@index([storeId])
}

enum DishType {
  VEG
  NON_VEG
  SNACK
  DRINK
}

enum KOTType {
  KITCHEN
  BAR
}

enum MeasuringUnit {
  GRAM
  KILOGRAM
  POUND
  LITRE
  MILLILITRE
  OUNCE
  PIECE
  PACKET
}

model AddOn {
  id          String    @id @default(uuid())
  name        String
  image       String?
  description String?
  type        AddOnType
  isAvailable Boolean   @default(true)
  sortOrder   Int       @default(0)
  categoryId  String?
  category    Category? @relation(fields: [categoryId], references: [id])
  
  storeId     String
  store       Store     @relation(fields: [storeId], references: [id])

  orderItemAddOns OrderItemAddOn[]
  price           Price?
  stocks          StockConsumption[]
  usedIn          DishAddOn[]

  createdAt DateTime @default(now())

  @@index([categoryId])
  @@index([storeId])
}

enum AddOnType {
  EXTRA
  ADDON
}

model DishAddOn {
  id      String @id @default(uuid())
  dishId  String
  addOnId String

  dish  Dish  @relation(fields: [dishId], references: [id])
  addOn AddOn @relation(fields: [addOnId], references: [id])

  @@index([dishId])
  @@index([addOnId])
}

model MenuSet {
  id        String  @id @default(uuid())
  name      String
  service   String
  isActive  Boolean @default(true)
  sortOrder Int     @default(0)
  
  storeId   String
  store     Store   @relation(fields: [storeId], references: [id])

  subMenus MenuSetSubMenu[]

  createdAt DateTime @default(now())
  
  @@index([storeId])
}

model MenuSetSubMenu {
  id        String @id @default(uuid())
  menuSetId String
  subMenuId String

  menuSet MenuSet @relation(fields: [menuSetId], references: [id])
  subMenu SubMenu @relation(fields: [subMenuId], references: [id])

  @@index([menuSetId])
  @@index([subMenuId])
}

model ComboOffer {
  id              String   @id @default(uuid())
  name            String 
  image           String[]
  hscode          String?
  preparationTime Int
  description     String?

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  subMenuId   String?
  subMenu     SubMenu?           @relation(fields: [subMenuId], references: [id])
  
  storeId     String
  store       Store              @relation(fields: [storeId], references: [id])
  
  sortOrder   Int                @default(0)
  kotType     KOTType
  isAvailable Boolean            @default(true)
  orderItems  OrderItem[]
  price       Price?
  items       ComboItem[]
  stocks      StockConsumption[]

  createdAt DateTime @default(now())

  @@index([categoryId])
  @@index([subMenuId])
  @@index([storeId])
}

model ComboItem {
  id      String @id @default(uuid())
  comboId String
  dishId  String

  quantity  Int
  unitPrice Float

  combo ComboOffer @relation(fields: [comboId], references: [id])
  dish  Dish       @relation(fields: [dishId], references: [id])

  @@index([comboId])
  @@index([dishId])
}

model Order {
  id        String        @id @default(uuid())
  tableId   String?
  type      OrderType
  table     Table?        @relation(fields: [tableId], references: [id])
  storeId   String?
  store     Store?        @relation(fields: [storeId], references: [id])
  sessionId String?
  session   TableSession? @relation(fields: [sessionId], references: [id])

  customerId String?
  customer   Customer?   @relation(fields: [customerId], references: [id])
  items      OrderItem[]
  total      Float

  paymentId String?
  payment   Payment? @relation(fields: [paymentId], references: [id])

  staffId String?
  staff   Staff?  @relation(fields: [staffId], references: [id])

  status    OrderStatus @default(PENDING)
  createdAt DateTime    @default(now())
  isDeleted Boolean     @default(false)

  @@index([tableId])
  @@index([sessionId])
  @@index([customerId])
  @@index([paymentId])
}

model OrderItem {
  id      String  @id @default(uuid())
  orderId String
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  dishId  String?
  dish    Dish?   @relation(fields: [dishId], references: [id])

  comboId               String?
  combo                 ComboOffer?      @relation(fields: [comboId], references: [id])
  quantity              Int
  unitPrice             Float
  totalPrice            Float
  complimentaryQuantity Int              @default(0)
  selectedAddOns        OrderItemAddOn[]
  status                OrderStatus      @default(PENDING)
  remarks               String?

  @@index([orderId])
  @@index([dishId])
  @@index([comboId])
}

model OrderItemAddOn {
  id          String    @id @default(uuid())
  orderItemId String
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  addOnId String
  addOn   AddOn  @relation(fields: [addOnId], references: [id])

  quantity  Int   @default(1)
  unitPrice Float

  @@index([orderItemId])
  @@index([addOnId])
}

enum OrderStatus {
  PENDING
  PREPARING
  READYTOPICK
  SERVED
  COMPLETED
  CANCELLED
}

model Payment {
  id String @id @default(uuid())

  orders Order[]

  sessionId String?       @unique
  session   TableSession? @relation(fields: [sessionId], references: [id])
  
  storeId   String
  store     Store         @relation(fields: [storeId], references: [id])

  method PaymentMethod
  amount Float
  status PaymentStatus @default(PENDING)

  transactionUuid String? @unique
  esewaRefId      String?

  createdAt DateTime @default(now())
  isDeleted Boolean  @default(false)

  @@index([sessionId])
  @@index([storeId])
}

enum PaymentMethod {
  CASH
  ESEWA
  QR
  BANK_TRANSFER
  CREDIT
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  CREDIT
}

enum OrderType {
  DINE_IN
  PICKUP
  DELIVERY
  RESERVATION
  QUICK_BILLING
  TAKE_AWAY
}

model Customer {
  id              String    @id @default(uuid())
  dob             DateTime?
  fullName        String
  phone           String?   @unique
  email           String?
  loyaltyId       String?   @unique
  openingBalance  Float     @default(0)
  creditLimit     Float?    @default(0)
  creditTermDays  Int?      @default(0)
  storeId         String?
  store           Store?    @relation(fields: [storeId], references: [id])
  loyaltyPoints   Int       @default(0)
  loyaltyDiscount Float     @default(0) // %

  legalName String?
  taxNumber String?

  address     String?
  reservation Reservation[]
  notes       String?

  orders Order[]

  createdAt      DateTime         @default(now())
  CustomerLedger CustomerLedger[]
  salesReturns   SalesReturn[]
}

model CustomerLedger {
  id         String   @id @default(uuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  txnNo          String     @unique
  type           LedgerType
  amount         Float
  closingBalance Float

  referenceId String? // orderId, paymentId, returnId
  remarks     String?

  createdAt DateTime @default(now())

  @@index([customerId])
}

enum LedgerType {
  SALE
  PAYMENT_IN
  PAYMENT_OUT
  RETURN
  ADJUSTMENT
  OPENING_BALANCE
}

model Reservation {
  id    String @id @default(uuid())
  name  String
  phone String

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id])

  images       String?
  remark       String?
  dateSelected ReservationTime[]
  tableId      String
  table        Table             @relation(fields: [tableId], references: [id])

  guests    Int
  status    ReservationStatus @default(PENDING)
  createdAt DateTime          @default(now())

  @@index([customerId])
  @@index([tableId])
}

model ReservationTime {
  id            String      @id @default(uuid())
  reservationId String
  reservation   Reservation @relation(fields: [reservationId], references: [id])
  date          DateTime
  startTime     DateTime
  endTime       DateTime

  @@index([reservationId])
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

model SalesReturn {
  id              String            @id @default(uuid())
  referenceNumber String            @unique
  customerId      String?
  customer        Customer?         @relation(fields: [customerId], references: [id])
  txnDate         DateTime          @default(now())
  billReference   String
  salesStaff      String?
  staffId         String? // Link to actual Staff ID if available
  staff           Staff?            @relation(fields: [staffId], references: [id])
  items           SalesReturnItem[]

  taxableAmount Float
  totalAmount   Float
  roundOff      Float @default(0)
  discount      Float @default(0)

  attachment String?
  remark     String?

  paymentStatus ReturnPaymentStatus @default(UNPAID)
  paymentMode   PaymentMethod?

  storeId       String
  store         Store     @relation(fields: [storeId], references: [id])

  createdAt DateTime @default(now())
  isDeleted Boolean  @default(false)

  @@index([customerId])
  @@index([storeId])
}

model SalesReturnItem {
  id            String      @id @default(uuid())
  salesReturnId String
  salesReturn   SalesReturn @relation(fields: [salesReturnId], references: [id], onDelete: Cascade)
  dishName      String
  quantity      Int
  rate          Float
  amount        Float

  @@index([salesReturnId])
}

enum ReturnPaymentStatus {
  PAID
  UNPAID
  CREDIT
}

model Staff {
  id           String        @id @default(uuid())
  name         String
  role         String        @default("Staff") // e.g. "Waiter", "Manager", "Chef"
  phone        String?
  email        String?
  isActive     Boolean       @default(true)
  
  storeId      String
  store        Store         @relation(fields: [storeId], references: [id])
  
  orders       Order[]
  image        String?
  salesReturns SalesReturn[]
  createdAt    DateTime      @default(now())
  
  @@index([storeId])
}

model Expense {
  id          String   @id @default(uuid())
  title       String
  amount      Float
  category    String? // e.g. "Rent", "Utilities", "Salary"
  date        DateTime @default(now())
  description String?
  
  storeId     String
  store       Store    @relation(fields: [storeId], references: [id])
  
  createdAt   DateTime @default(now())
  
  @@index([storeId])
}

model Purchase {
  id        String   @id @default(uuid())
  item      String
  quantity  Int
  amount    Float
  vendor    String?
  date      DateTime @default(now())
  
  storeId   String
  store     Store    @relation(fields: [storeId], references: [id])
  
  createdAt DateTime @default(now())
  
  @@index([storeId])
}

model SystemSetting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}

model Store {
  id        String     @id @default(cuid())
  name      String
  ownerId   String     @unique
  users     User[]
  menus     Menu[]
  orders    Order[]
  customers Customer[]
  
  // Multi-tenancy relations
  spaces      Space[]
  tables      Table[]
  tableTypes  TableType[]
  categories  Category[]
  subMenus    SubMenu[]
  dishes      Dish[]
  addOns      AddOn[]
  combos      ComboOffer[]
  menuSets    MenuSet[]
  stocks      Stock[]
  payments    Payment[]
  staff       Staff[]
  expenses    Expense[]
  purchases   Purchase[]
  salesReturns SalesReturn[]
}

model User {
  id       String  @id @default(cuid())
  name     String?
  email    String  @unique
  password String
  role     Role    @default(CASHIER)

  // Auth & Verification
  verificationCode        String?
  verificationCodeExpires DateTime?
  emailVerified           DateTime?
  isSetupComplete         Boolean   @default(false)

  // Trial Management
  trialEndsAt DateTime?

  storeId  String?
  store    Store?    @relation(fields: [storeId], references: [id])
  sessions Session[]
}

enum Role {
  ADMIN
  MANAGER
  CASHIER
}

model Menu {
  id        String   @id @default(cuid())
  name      String
  storeId   String
  store     Store    @relation(fields: [storeId], references: [id])
  createdAt DateTime @default(now())
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}
