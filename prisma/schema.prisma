datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Space {
  id          String   @id @default(uuid())
  name        String
  description String?
  tables      Table[]
  createdAt   DateTime @default(now())
}

model TableSession {
  id      String @id @default(uuid())
  tableId String
  table   Table  @relation(fields: [tableId], references: [id], onDelete: Cascade)

  startedAt DateTime  @default(now())
  endedAt   DateTime?

  total         Float @default(0)
  serviceCharge Float @default(0)
  tax           Float @default(0)
  grandTotal    Float @default(0)

  isActive Boolean @default(true)
}

model TableType {
  id     String  @id @default(uuid())
  name   String  @unique
  tables Table[]
}

model Table {
  id          String         @id @default(uuid())
  name        String
  tableTypeId String?
  tableType   TableType?     @relation(fields: [tableTypeId], references: [id])
  capacity    Int
  status      TableStatus    @default(ACTIVE)
  spaceId     String?
  space       Space?         @relation(fields: [spaceId], references: [id])
  qrCode      QRCode?
  sessions    TableSession[]
  createdAt   DateTime       @default(now())
  Order       Order[]
}

model QRCode {
  id        String   @id @default(uuid())
  tableId   String   @unique
  table     Table    @relation(fields: [tableId], references: [id], onDelete: Cascade)
  value     String
  assigned  Boolean  @default(false)
  createdAt DateTime @default(now())
}

enum TableStatus {
  ACTIVE
  OCCUPIED
  INACTIVE
}

model Category {
  id          String  @id @default(uuid())
  name        String  @unique
  image       String?
  description String?

  dishes Dish[]
  combos ComboOffer[]

  createdAt DateTime @default(now())
}

model SubMenu {
  id       String  @id @default(uuid())
  name     String  @unique
  image    String?
  isActive Boolean @default(true)

  dishes  Dish[]
  combos  ComboOffer[]
  menuSet MenuSetSubMenu[]

  createdAt DateTime @default(now())
}

model Price {
  id            String @id @default(uuid())
  actualPrice   Float
  discountPrice Float? @default(0)
  listedPrice   Float
  cogs          Float
  grossProfit   Float

  dishId  String? @unique
  addOnId String? @unique
  comboId String? @unique

  dish  Dish?       @relation(fields: [dishId], references: [id])
  addOn AddOn?      @relation(fields: [addOnId], references: [id])
  combo ComboOffer? @relation(fields: [comboId], references: [id])
}

model Stock {
  id           String             @id @default(uuid())
  name         String             @unique
  unit         MeasuringUnit?
  quantity     Float
  amount       Float
  consumptions StockConsumption[]
}

model StockConsumption {
  id      String @id @default(uuid())
  stockId String
  stock   Stock  @relation(fields: [stockId], references: [id])

  quantity Float

  dishId  String?
  addOnId String?
  comboId String?

  dish  Dish?       @relation(fields: [dishId], references: [id])
  addOn AddOn?      @relation(fields: [addOnId], references: [id])
  combo ComboOffer? @relation(fields: [comboId], references: [id])
}

model Dish {
  id              String   @id @default(uuid())
  name            String
  hscode          String?
  image           String[]
  preparationTime Int
  description     String?

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  subMenuId String?
  subMenu   SubMenu? @relation(fields: [subMenuId], references: [id])

  type        DishType
  kotType     KOTType
  isAvailable Boolean            @default(true)
  orderItems  OrderItem[]
  price       Price?
  stocks      StockConsumption[]
  addOns      DishAddOn[]
  comboItems  ComboItem[]
  createdAt   DateTime           @default(now())
}

enum DishType {
  VEG
  NON_VEG
  SNACK
  DRINK
}

enum KOTType {
  KITCHEN
  BAR
}

enum MeasuringUnit {
  GRAM
  KILOGRAM
  POUND
  LITRE
  MILLILITRE
  OUNCE
  PIECE
  PACKET
}

model AddOn {
  id              String             @id @default(uuid())
  name            String
  image           String?
  description     String?
  type            AddOnType
  isAvailable     Boolean            @default(true)
  orderItemAddOns OrderItemAddOn[]
  price           Price?
  stocks          StockConsumption[]
  usedIn          DishAddOn[]

  createdAt DateTime @default(now())
}

enum AddOnType {
  EXTRA
  ADDON
}

model DishAddOn {
  id      String @id @default(uuid())
  dishId  String
  addOnId String

  dish  Dish  @relation(fields: [dishId], references: [id])
  addOn AddOn @relation(fields: [addOnId], references: [id])
}

model MenuSet {
  id       String  @id @default(uuid())
  name     String
  service  String
  isActive Boolean @default(true)

  subMenus MenuSetSubMenu[]

  createdAt DateTime @default(now())
}

model MenuSetSubMenu {
  id        String @id @default(uuid())
  menuSetId String
  subMenuId String

  menuSet MenuSet @relation(fields: [menuSetId], references: [id])
  subMenu SubMenu @relation(fields: [subMenuId], references: [id])
}

model ComboOffer {
  id              String   @id @default(uuid())
  name            String
  image           String[]
  hscode          String?
  preparationTime Int
  description     String?

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  subMenuId String?
  subMenu   SubMenu? @relation(fields: [subMenuId], references: [id])

  kotType     KOTType
  isAvailable Boolean            @default(true)
  orderItems  OrderItem[]
  price       Price?
  items       ComboItem[]
  stocks      StockConsumption[]

  createdAt DateTime @default(now())
}

model ComboItem {
  id      String @id @default(uuid())
  comboId String
  dishId  String

  quantity  Int
  unitPrice Float

  combo ComboOffer @relation(fields: [comboId], references: [id])
  dish  Dish       @relation(fields: [dishId], references: [id])
}

model Order {
  id         String      @id @default(uuid())
  tableId    String?
  type       OrderType
  table      Table?      @relation(fields: [tableId], references: [id])
  customerId String?
  customer   Customer?   @relation(fields: [customerId], references: [id])
  items      OrderItem[]
  total      Float
  payment    Payment?
  status     OrderStatus @default(PENDING)
  createdAt  DateTime    @default(now())
}

model OrderItem {
  id      String  @id @default(uuid())
  orderId String
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  dishId  String?
  dish    Dish?   @relation(fields: [dishId], references: [id])

  comboId        String?
  combo          ComboOffer?      @relation(fields: [comboId], references: [id])
  quantity       Int
  unitPrice      Float
  totalPrice     Float
  selectedAddOns OrderItemAddOn[]
  status         OrderStatus      @default(PENDING)
  remarks        String?
}

model OrderItemAddOn {
  id          String    @id @default(uuid())
  orderItemId String
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  addOnId String
  addOn   AddOn  @relation(fields: [addOnId], references: [id])

  quantity  Int   @default(1)
  unitPrice Float
}

enum OrderStatus {
  PENDING
  PREPARING
  READYTOPICK
  SERVED
  COMPLETED
  CANCELLED
}

model Payment {
  id        String        @id @default(uuid())
  orderId   String        @unique
  order     Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  method    PaymentMethod
  amount    Float
  status    PaymentStatus @default(PENDING)
  createdAt DateTime      @default(now())
}

enum PaymentMethod {
  CASH
  ESEWA
  QR
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
}

enum OrderType {
  DINE_IN
  PICKUP
  DELIVERY
  RESERVATION
  QUICK_BILLING
  TAKE_AWAY
}

model Customer {
  id             String    @id @default(uuid())
  dob            DateTime?
  fullName       String
  phone          String?   @unique
  email          String?
  loyaltyId      String?   @unique
  openingBalance Float     @default(0)
  creditLimit    Float?    @default(0)
  creditTermDays Int?      @default(0)

  loyaltyPoints   Int   @default(0)
  loyaltyDiscount Float @default(0) // %

  legalName String?
  taxNumber String?

  address String?

  notes String?

  orders Order[]

  createdAt      DateTime         @default(now())
  CustomerLedger CustomerLedger[]
}

model CustomerLedger {
  id         String   @id @default(uuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  txnNo          String     @unique
  type           LedgerType
  amount         Float
  closingBalance Float

  referenceId String? // orderId, paymentId, returnId
  remarks     String?

  createdAt DateTime @default(now())
}

enum LedgerType {
  SALE
  PAYMENT_IN
  PAYMENT_OUT
  RETURN
  ADJUSTMENT
  OPENING_BALANCE
}
